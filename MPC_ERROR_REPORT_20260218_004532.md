# MPC Path Tracking â€” ìˆ˜ì • ì™„ë£Œ í•­ëª© + ê²½ë¡œ ì´íƒˆ ì›ì¸ ë¶„ì„

**ìµœì¢… í™•ì¸ì¼:** 2026-02-18
**ìˆ˜ì • ì™„ë£Œ:** 19/19ê°œ
**ë¯¸ìˆ˜ì •:** 0ê°œ

---

## âœ… TRACKING FAILURE ëŒ€ì‘ â€” `ref_preview_steps` ê³¼ë‹¤ ì„¤ì • ì™„í™”

**File:** `config/cav_config.yaml` (`ref_preview_steps` í•­ëª©)
**Severity:** ğŸ”´ Critical (ì‹¤ì œ ì¶”ì¢… ì‹¤íŒ¨ ì›ì¸)
**ì¦ìƒ:** ì§ì„  êµ¬ê°„ì€ ì¶”ì¢…ë˜ì§€ë§Œ ì»¤ë¸Œ ì§„ì… ì‹œ ê²½ë¡œì—ì„œ í¬ê²Œ ì´íƒˆ

### ì›ì¸

`buildReferenceProfiles()`ì—ì„œ MPCì˜ ê¸°ì¤€ ì°¸ì¡°ì ì€ `closest + ref_preview_steps` ë²ˆì§¸ ê²½ë¡œì :

```cpp
// ltv_model.cpp
const int start_idx = closest + cfg_.ref_preview_steps;  // = 0 + 32 = 32
x0(0) = dr;      // path[32]ê¹Œì§€ì˜ íš¡ë°©í–¥ ì˜¤ì°¨ (ì´ˆê¸° ìƒíƒœ)
x0(3) = theta_r; // path[32]ì—ì„œì˜ ê¸°ì¤€ ë°©í–¥
```

**MPC ì˜ˆì¸¡ ê±°ë¦¬ vs ì°¸ì¡°ì  ê±°ë¦¬ ë¹„êµ:**

| í•­ëª© | ê°’ |
|------|----|
| ì˜ˆì¸¡ ìŠ¤í… N | 60 |
| ì‹œê°„ ê°„ê²© Ts | 0.05 s |
| ìµœëŒ€ ì†ë„ v | 0.55 m/s |
| **MPC ì‹¤ì œ ì»¤ë²„ ê±°ë¦¬** | **60 Ã— 0.05 Ã— 0.55 â‰ˆ 1.65 m** |
| ê²½ë¡œì  ê°„ê²© (ì¶”ì •) | ~0.1 m |
| `ref_preview_steps=32` ê±°ë¦¬ | **32 Ã— 0.1 = 3.2 m** |

ì°¸ì¡°ì ì´ MPC ì˜ˆì¸¡ ê±°ë¦¬(1.65 m)ë³´ë‹¤ **ì•½ 2ë°° ë¨¼** 3.2 m ì•ì— ìœ„ì¹˜.

### ì‹¤íŒ¨ ë©”ì»¤ë‹ˆì¦˜

**ì§ì„  êµ¬ê°„:** path[0]ê³¼ path[32]ê°€ ë™ì¼ ë°©í–¥ â†’ íš¡ë°©í–¥ ì˜¤ì°¨ `dr â‰ˆ 0` â†’ ì •ìƒ âœ…

**ì»¤ë¸Œ ì§„ì… ì‹œ:**
1. path[32]ëŠ” ì´ë¯¸ ì»¤ë¸Œ ì•ˆìª½ì— ìœ„ì¹˜
2. ì°¨ëŸ‰ì´ path[0]ì— ìˆì„ ë•Œ path[32]ê¹Œì§€ì˜ íš¡ë°©í–¥ ì˜¤ì°¨ `dr`ì´ í¬ê²Œ ë°œìƒ
   - ì˜ˆ: ì»¤ë¸Œ ë°˜ê²½ 2 m, í˜¸ ê¸¸ì´ 3.2 m â†’ `dr â‰ˆ 2.56 m`
3. `w_d=100`(ìœ„ì¹˜ ê°€ì¤‘ì¹˜ê°€ ë§¤ìš° í¼) â†’ MPCê°€ ì´ í° ì˜¤ì°¨ë¥¼ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ **ìµœëŒ€ ì¡°í–¥ ëª…ë ¹** ì¶œë ¥
4. ì°¨ëŸ‰ì´ ì»¤ë¸Œì—ì„œ ì˜¤ë²„ìŠˆíŠ¸ â†’ ê²½ë¡œ ì´íƒˆ
5. MPC ì˜ˆì¸¡ êµ¬ê°„(path[32]~path[92])ì´ **path[0]~path[32] êµ¬ê°„ ê²½ë¡œ í˜•ìƒì„ ë°˜ì˜í•˜ì§€ ëª»í•¨** â†’ ì»¤ë¸Œ ì§„ì… ê²½ë¡œ ë¬´ì‹œí•œ ëª…ë ¹ ìƒì„±

### í•´ê²°

`cav_config.yaml` ì—ì„œ `ref_preview_steps` ê°’ ì¶•ì†Œ:

```yaml
# ìˆ˜ì • ì „ (ëª¨ë“  CAV ìŠ¬ë¡¯)
ref_preview_steps: 32   # CAV01/02
ref_preview_steps: 36   # CAV03
ref_preview_steps: 34   # CAV04

# ìˆ˜ì • í›„ â€” ì˜µì…˜ A: ë³´ìˆ˜ì  (ì¶”ì²œ)
ref_preview_steps: 0    # preview ë¹„í™œì„±, N=60 horizonì´ lookahead ë‹´ë‹¹

# ìˆ˜ì • í›„ â€” ì˜µì…˜ B: ì™„ë§Œí•œ preview ìœ ì§€
ref_preview_steps: 8    # MPC ì˜ˆì¸¡ ê±°ë¦¬(1.65m) ë‚´ì— ë“¤ì–´ì˜¤ëŠ” ê°’ â‰ˆ 16ì , ì ˆë°˜ìœ¼ë¡œ ë³´ìˆ˜ ì„¤ì •
```

Nì„ ëŠ˜ë ¤ ì˜ˆì¸¡ ê±°ë¦¬ë¥¼ previewì™€ ë§ì¶”ëŠ” ë°©ë²•ë„ ê°€ëŠ¥:

```yaml
horizon: 100    # 60 â†’ 100: ì˜ˆì¸¡ ê±°ë¦¬ â‰ˆ 2.75 m, ref_preview_steps=32(3.2m)ì— ê·¼ì ‘
```

### ì ìš© ìƒíƒœ

í˜„ì¬ `cav_config.yaml`ì—ì„œ CAV01~04 ëª¨ë‘ `ref_preview_steps: 8` ì ìš© ì™„ë£Œ.
ê¸‰ì»¤ë¸Œê°€ ë§ì€ ë§µ ê¸°ì¤€ ë³´ìˆ˜ íŠœë‹ê°’ìœ¼ë¡œ, í•„ìš” ì‹œ `5~10` ë²”ìœ„ì—ì„œ ë¯¸ì„¸ ì¡°ì • ê¶Œì¥.

---

---

## âœ… ERROR-10 â€” ìµœê·¼ì ‘ ì¸ë±ìŠ¤ ë…ë¦½ ê³„ì‚° (ìˆ˜ì •ë¨)

**File:** `src/ltv_mpc/ltv_model.cpp:63`
**Severity:** ğŸŸ¡ Medium

**ë¬¸ì œ:**
`local_path_pub_cpp`ê°€ ë°œí–‰í•˜ëŠ” local_pathëŠ” **ì°¨ëŸ‰ í˜„ì¬ ìœ„ì¹˜ ì•ìª½ 140ì **ë§Œ í¬í•¨.
ê·¸ëŸ¬ë‚˜ MPC ë‚´ë¶€ `findClosestIndex()`ëŠ” ê·¸ 140ì  **ì „ì²´ë¥¼ ë¬´ì°¨ë³„ íƒìƒ‰**í•¨.

```cpp
// ltv_model.cpp:63 â€” í˜„ì¬ (ì „ì²´ íƒìƒ‰)
for (size_t i = 0; i < path.size(); ++i) {
    const double score = d2 + 0.03 * static_cast<double>(i);
    ...
}
```

ê¸‰ì»¤ë¸Œ êµ¬ê°„ì—ì„œ ì°¨ëŸ‰ì´ ê²½ë¡œ ì•ˆìª½ìœ¼ë¡œ ì ë¦´ ë•Œ **ì´ë¯¸ ì§€ë‚˜ì¹œ ì **ì´ ê°€ì¥ ê°€ê¹ë‹¤ê³  íŒë‹¨ë  ìˆ˜ ìˆìŒ
â†’ ê¸°ì¤€ì ì´ ë’¤ë¡œ ì í”„ â†’ MPCê°€ ë°˜ëŒ€ ë°©í–¥ ì¡°í–¥ ëª…ë ¹ ìƒì„± â†’ ì§„ë™/ì´íƒˆ.

**í•´ê²°:**
local_pathëŠ” ì´ë¯¸ ì•ìª½ ì ë§Œ í¬í•¨í•˜ë¯€ë¡œ íƒìƒ‰ ë²”ìœ„ë¥¼ ì•ìª½ ì¼ë¶€ë¡œ ì œí•œ:

```cpp
// ltv_model.cpp findClosestIndex() ìˆ˜ì •
int LTVModel::findClosestIndex(...) {
    if (path.empty()) return -1;

    const double x = ego_pose.position.x;
    const double y = ego_pose.position.y;
    double best = std::numeric_limits<double>::max();
    int best_idx = 0;

    // ì „ì²´ íƒìƒ‰ ëŒ€ì‹  ì•ìª½ 30ì ë§Œ íƒìƒ‰
    const int search_limit = std::min(static_cast<int>(path.size()), 30);

    for (int i = 0; i < search_limit; ++i) {
        const double dx = path[i].pose.position.x - x;
        const double dy = path[i].pose.position.y - y;
        const double d2 = dx * dx + dy * dy;
        const double score = d2 + 0.03 * static_cast<double>(i);
        if (score < best) {
            best = score;
            best_idx = i;
        }
    }
    return best_idx;
}
```

---

## âœ… ERROR-14 â€” R_v / R_w íŒŒë¼ë¯¸í„° ì´ë¦„ ì˜ë¯¸ ë¶ˆì¼ì¹˜ (ìˆ˜ì •ë¨)

**File:** `config/cav_config.yaml:43`
**Severity:** ğŸŸ¡ Medium

**ë¬¸ì œ:**
```yaml
R_v: 2.0   # ì½”ë“œì—ì„œ w_kappa (ê³¡ë¥  í˜ë„í‹°)ë¡œ ë§¤í•‘ë¨
R_w: 0.5   # ì½”ë“œì—ì„œ w_u (ì…ë ¥ ë³€í™”ìœ¨ í˜ë„í‹°)ë¡œ ë§¤í•‘ë¨
```
ì´ë¦„ë§Œ ë³´ë©´ ì†ë„/ê°ì†ë„ ì œì–´ ê°€ì¤‘ì¹˜ì²˜ëŸ¼ ì½í˜€ íŠœë‹ ì‹œ í˜¼ë€ ë°œìƒ.

**í•´ê²°:**
`cav_config.yaml` íŒŒë¼ë¯¸í„° ì´ë¦„ì„ ì‹¤ì œ ì˜ë¯¸ë¡œ ë³€ê²½:

```yaml
# ìˆ˜ì • ì „
R_v: 2.0
R_w: 0.5

# ìˆ˜ì • í›„
weight_curvature: 2.0   # w_kappa â€” ê³¡ë¥  í˜ë„í‹°
weight_input: 0.5       # w_u â€” ì…ë ¥ ë³€í™”ìœ¨ í˜ë„í‹°
```

`mpc_path_tracker_cpp.cpp`ì˜ legacy ë§¤í•‘ ì½”ë“œ:
```cpp
// ì œê±° ë˜ëŠ” deprecated í‘œì‹œ
const double r_v = read_nan_double("R_v");
if (std::isfinite(r_v)) cfg.w_kappa = r_v;
const double r_w = read_nan_double("R_w");
if (std::isfinite(r_w)) cfg.w_u = r_w;
```

---

## âœ… ERROR-17 â€” HV 19 / 20 ë™ì¼ ê²½ë¡œ (ìˆ˜ì •ë¨)

**File:** `config/cav_config.yaml:123`
**Severity:** ğŸŸ¢ Low

**ë¬¸ì œ:**
```yaml
hv_settings:
  - id: 19
    node_sequence: [38, 41, 62, 38]
  - id: 20
    node_sequence: [38, 41, 62, 38]  # ì™„ì „ ë™ì¼
```
ë‘ HVê°€ ê°™ì€ ê²½ë¡œ â†’ ìœ„ì¹˜ ê²¹ì¹¨, ì¶©ëŒ ê°€ëŠ¥.

**í•´ê²°:**
ì˜ë„ í™•ì¸ í›„ ë¶„ë¦¬:
```yaml
hv_settings:
  - id: 19
    node_sequence: [38, 41, 62, 38]
  - id: 20
    node_sequence: [62, 41, 38, 62]   # ë°˜ëŒ€ ë°©í–¥ ë˜ëŠ” ë‹¤ë¥¸ ê²½ë¡œ
```

---

## âœ… ERROR-19 â€” ì œì–´ ë£¨í”„ë§ˆë‹¤ íŒŒë¼ë¯¸í„° 3íšŒ ì¤‘ë³µ ì½ê¸° (ìˆ˜ì •ë¨)

**File:** `src/mpc_path_tracker_cpp.cpp:296`, `src/mpc_path_tracker_cpp.cpp:423`
**Severity:** ğŸŸ¢ Low

**ë¬¸ì œ:**
`get_effective_horizon()`ì´ 20Hz ë£¨í”„ë§ˆë‹¤ íŒŒë¼ë¯¸í„° ì„œë²„ë¥¼ 3íšŒ í˜¸ì¶œ:

```cpp
int MPCPathTrackerCpp::get_effective_horizon() const {
    int n = this->get_parameter("prediction_horizon").as_int(); // 1íšŒ
    const int horizon_legacy = this->get_parameter("horizon").as_int(); // 2íšŒ
    const int n_new = this->get_parameter("N").as_int(); // 3íšŒ
    ...
}
// control_loop()ì—ì„œ 1íšŒ, publish_performance()ì—ì„œ 1íšŒ â†’ ë£¨í”„ë‹¹ ì´ 6íšŒ
```

**í•´ê²°:**
`update_controller_params()` ì‹¤í–‰ ì‹œ ìºì‹œ:

```cpp
// mpc_path_tracker_cpp.hpp ë©¤ë²„ ë³€ìˆ˜ ì¶”ê°€
int cached_horizon_ = 20;

// update_controller_params() ë§ˆì§€ë§‰ì— ì¶”ê°€
cached_horizon_ = cfg.N;

// get_effective_horizon() ëŒ€ì‹  cached_horizon_ ì§ì ‘ ì‚¬ìš©
const size_t min_path_points = static_cast<size_t>(cached_horizon_ + 10);
msg.horizon = cached_horizon_;
```
