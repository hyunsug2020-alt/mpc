# CAV01 MPC ê°œë°œ ë¡œê·¸ â€” 2026-02-20

---

## ì‘ì—… ìš”ì•½

### 1. ì›Œí¬ìŠ¤í˜ì´ìŠ¤ í™•ì¸
- ì‘ì—… ë””ë ‰í† ë¦¬: `/home/david/Mobility_Challenge_Simulator/`
- íŒ¨í‚¤ì§€: `bisa`
- ë¹Œë“œ: `colcon build --packages-select bisa`

---

## 2. ì´ˆê¸° ë¬¸ì œ ë¶„ì„ (ì½”ë“œ ì ê²€)

### ë°œê²¬ëœ ì£¼ìš” ì´ìŠˆ

| ì‹¬ê°ë„ | íŒŒì¼ | ë¬¸ì œ |
|--------|------|------|
| ğŸ”´ í¬ë¦¬í‹°ì»¬ | `ltv_model.cpp:123` | `kappa_r_seq[k+1]` bounds check ì—†ìŒ |
| ğŸ”´ í¬ë¦¬í‹°ì»¬ | `ltv_model.cpp:172` | í–‰ë ¬ singular ìœ„í—˜ |
| ğŸŸ¡ ì¤‘ê°„ | `ltv_solver.cpp:81` | OSQP ì‹¤íŒ¨ ì‹œ ê²½ê³  ì—†ìŒ |
| ğŸŸ¡ ì¤‘ê°„ | `cav_config.yaml` | CAV01 íŒŒë¼ë¯¸í„° ë‹¤ë¥¸ CAVì™€ ë¶ˆê· í˜• |
| ğŸŸ¢ ë‚®ìŒ | `priority_collision_gate.cpp` | ë¼ìš´ë“œì–´ë°”ì›ƒ ì¢Œí‘œ í•˜ë“œì½”ë”© |

---

## 3. CAV01 íŒŒë¼ë¯¸í„° íŠœë‹

### ë¬¸ì œ: ì˜¤ë²„ìŠˆíŠ¸ ë° ê²½ë¡œ ì´íƒˆ
**ì›ì¸:**
- `ref_preview_steps: 0` â†’ ì»¤ë¸Œ ë¯¸ë¦¬ ë³´ì§€ ì•ŠìŒ
- `max_omega_rate: 2.5` â†’ ì¡°í–¥ ë°˜ì‘ ë„ˆë¬´ ëŠë¦¼
- `weight_input: 15.0` â†’ ì¡°í–¥ í˜ë„í‹° ê³¼ë„í•´ MPCê°€ ì•ˆ êº¾ìŒ

**ì ìš©ëœ ìˆ˜ì • (cav_config.yaml):**
```yaml
# ë³€ê²½ ì „ â†’ ë³€ê²½ í›„
ref_preview_steps: 0   â†’  12
max_omega_rate:   2.5  â†’  10.0
weight_input:    15.0  â†’  0.55
max_omega_abs:    0.8  â†’  0.95
max_velocity:    0.45  â†’  0.34
```

---

## 4. Gutjahr 2017 ë…¼ë¬¸ ê¸°ë°˜ íš¡ë°©í–¥ ì´íƒˆ ì œì•½ êµ¬í˜„

### ë…¼ë¬¸: *Lateral Vehicle Trajectory Optimization Using Constrained Linear Time-Varying MPC* (IEEE ITS 2017)

### êµ¬í˜„ ë‚´ìš©

#### 1ì°¨ ì‹œë„ (Hard Constraint) â€” ì‹¤íŒ¨
- `lateral_bound: 0.35` ë¥¼ hard constraintë¡œ ì¶”ê°€
- ì»¤ë¸Œ ì§„ì… ì‹œ OSQP **infeasible** â†’ ì°¨ëŸ‰ ì •ì§€

#### 2ì°¨ ì‹œë„ (Adaptive Bound) â€” ì‹¤íŒ¨
- `y_free` ê¸°ë°˜ adaptive bound â†’ **ë³´ì • ì–µì œ**ë¡œ ì˜¤ë²„ìŠˆíŠ¸ ì•…í™”

#### 3ì°¨ ì‹œë„ (Slack Variable Soft Constraint) â€” **ìµœì¢… ì±„íƒ** âœ…

**ë…¼ë¬¸ Section V, eq.(21)~(23) êµ¬í˜„:**

ìµœì í™” ë³€ìˆ˜ í™•ì¥: `Å© = [u(N); Îµ_u(1); Îµ_l(1)]` â†’ **N+2 ì°¨ì›**

ë¹„ìš©í•¨ìˆ˜ augment:
```
PÌƒ = diag(P, 2Â·w_sq, 2Â·w_sq)
qÌƒ = [q; w_lin; w_lin]
```

ì œì•½ ì¡°ê±´ (soft):
```
ìƒí•œ soft: [Cy | -1â‚™ | 0â‚™] Â· Å© â‰¤  d_bound - y_free   (eq.22 upper)
í•˜í•œ soft: [Cy |  0â‚™ | 1â‚™] Â· Å© â‰¥ -d_bound - y_free   (eq.22 lower)
slack ë¹„ìŒ: Îµ_u â‰¥ 0, Îµ_l â‰¥ 0
```

**í•­ìƒ feasible** (slackì´ bound ìœ„ë°˜ í¡ìˆ˜) â†’ ì°¨ëŸ‰ ì •ì§€ ë¬¸ì œ í•´ê²°

#### ë³€ê²½ íŒŒì¼

| íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|------|-----------|
| `src/bisa/src/ltv_mpc/ltv_types.hpp` | `lateral_bound`, `w_lateral_slack_lin`, `w_lateral_slack_quad` ì¶”ê°€ |
| `src/bisa/src/ltv_mpc/ltv_mpc.hpp` | `buildInputConstraints` + `buildLateralSlackConstraints` ë¶„ë¦¬ |
| `src/bisa/src/ltv_mpc/ltv_mpc.cpp` | Slack variable QP augmentation êµ¬í˜„ |
| `src/bisa/src/mpc_path_tracker_cpp.cpp` | íŒŒë¼ë¯¸í„° ì„ ì–¸ ë° ì½ê¸° ì¶”ê°€ |
| `src/bisa/config/cav_config.yaml` | CAV01 íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸ |

#### í˜„ì¬ CAV01 ì„¤ì •ê°’
```yaml
lateral_bound:          0.35     # ê²½ë¡œ Â±35cm soft ì œì•½
w_lateral_slack_lin:  5000.0    # ë…¼ë¬¸ kâ‚ (ì„ í˜• íŒ¨ë„í‹°)
w_lateral_slack_quad: 50000.0   # ë…¼ë¬¸ Kâ‚‚ (ì´ì°¨ íŒ¨ë„í‹°)
```

---

## 5. Guard ë¡œì§ êµ¬í˜„ (mpc_path_tracker_cpp.cpp)

### ì¶”ê°€ëœ ê¸°ëŠ¥ (path_hold ë¸”ë¡ ë‚´ë¶€)

#### â‘  curve_speed (ì»¤ë¸Œ ì†ë„ ê°ì†Œ)
```
heading_error > threshold ì‹œ v_cmd ë¹„ë¡€ ê°ì†Œ
ratio = max(min_ratio, 1 - gain Ã— excess)
```

#### â‘¡ overshoot_guard (ê²½ë¡œ ì´íƒˆ ì‹œ omega ëŒí•‘)
```
|cross_track_error| > distance ì‹œ w_cmd *= damping
```

#### â‘¢ oscillation_guard (ì§„ë™ ê°ì§€ ì‹œ omega ëŒí•‘)
```
CTE ë˜ëŠ” heading_error ë¶€í˜¸ ë°˜ì „ ê°ì§€ ì‹œ w_cmd *= damping
```

#### config íŒŒë¼ë¯¸í„°
```yaml
curve_speed_enable:              true
curve_speed_heading_threshold:   0.22   # rad
curve_speed_reduction_gain:      0.58
curve_speed_min_ratio:           0.45
overshoot_guard_distance:        0.35   # m
overshoot_reverse_damping:       0.75
oscillation_guard_enable:        true
oscillation_guard_cte_deadband:  0.12   # m
oscillation_guard_heading_deadband: 0.24  # rad
oscillation_guard_reverse_damping:  0.82
```

---

## 6. CAV01 MPC ë””ë²„ê·¸ ëŒ€ì‹œë³´ë“œ (mpc_dashboard.py)

### 6ê°œ íŒ¨ë„ êµ¬ì„±

| # | íŒ¨ë„ ì´ë¦„ | ë‚´ìš© | ì£¼ìš” í™œìš© |
|---|-----------|------|-----------|
| â‘  | ì‹¤ì œ/ì°¸ì¡°/ì˜ˆì¸¡ ê¶¤ì  | XY ê²½ë¡œ ì‹œê°í™” | ì „ì²´ ê²½ë¡œ ì¶”ì¢… ìƒíƒœ |
| â‘¡ | ê²½ë¡œ ì¶”ì¢… ì˜¤ì°¨ìœ¨ | CTE + ë¡¤ë§RMSE + warn/crit ì„ê³„ì„  | **ê²½ë¡œ ì´íƒˆ ì •ëŸ‰í™”** |
| â‘¢ | ì»¤ë¸Œ êµ¬ê°„ ì˜¤ì°¨ìœ¨ | Heading ì˜¤ì°¨(Â°) + ê²½ë¡œ ê³¡ë¥  ì˜¤ë²„ë ˆì´ | **ì»¤ë¸Œ ì¶”ì¢… í’ˆì§ˆ** |
| â‘£ | ì¡°í–¥ ëª…ë ¹ ë¶„ì„ | Ï‰ ëª…ë ¹ + ë¶€í˜¸ë°˜ì „(ì˜¤ë²„ìŠˆíŠ¸) ê°ì§€ | **ì˜¤ë²„ìŠˆíŠ¸ ì›ì¸ ë¶„ì„** |
| â‘¤ | ì†ë„ í”„ë¡œíŒŒì¼ | ì†ë„ + ê¸‰ì»¤ë¸Œ êµ¬ê°„ ë°°ê²½ ê°•ì¡° | curve_speed íš¨ê³¼ í™•ì¸ |
| â‘¥ | MPC ì†”ë²„ ì„±ëŠ¥ | solver time + ë¡¤ë§RMSE ì¶”ì„¸ | **ì¶”ì¢… í’ˆì§ˆ ì¶”ì„¸** |

### íŠ¹ì§•
- í•œê¸€ í°íŠ¸: `Noto Sans CJK JP` ìë™ ì ìš©
- ì´ë™í‰ê·  ìŠ¤ë¬´ë”© (window=7) ì ìš©
- 20Hz ê°±ì‹  (50ms interval)
- ëŸ°ì¹˜íŒŒì¼ ìë™ ì‹¤í–‰ í¬í•¨

### ì‹¤í–‰
```bash
python3 mpc_dashboard.py --cav_id 1 --warn 0.20 --crit 0.35 --fps 20
```

---

## 7. ëŸ°ì¹˜íŒŒì¼ êµ¬ì„± (problem3_cpp_launch.py)

ìë™ ì‹¤í–‰ í”„ë¡œì„¸ìŠ¤:
1. `mpc_parameter_tuner.py` â€” íŒŒë¼ë¯¸í„° íŠœë„ˆ GUI
2. `mpc_dashboard.py --cav_id 1 --warn 0.20 --crit 0.35 --fps 20` â€” CAV01 ë””ë²„ê·¸ ëŒ€ì‹œë³´ë“œ
3. `rviz2` â€” ì‹œë®¬ë ˆì´í„° ì‹œê°í™”
4. `hdmap_visualizer` â€” HD ë§µ
5. HV ì°¨ëŸ‰ (id 19, 20)
6. CAV01~04 ë…¸ë“œ (global_path_pub, local_path_pub, mpc_path_tracker)

---

## 8. ë¯¸í•´ê²° â†’ í•´ê²° ì™„ë£Œ

| ìƒíƒœ | ë‚´ìš© |
|------|------|
| âœ… í•´ê²° | CAV01 ì˜¤ë²„ìŠˆíŠ¸ â€” ì•„ë˜ 3ê°€ì§€ ë ˆë²¨ë¡œ ì²˜ë¦¬ |
| âœ… í•´ê²° | ì»¤ë¸Œ ê²½ë¡œ ì´íƒˆ â€” Îº QP ë‚´ë¶€ hard constraint + path_hold ë³´ì • í™œì„±í™” |
| âœ… í•´ê²° | ëŒ€ì‹œë³´ë“œ í•œê¸€ ë„¤ëª¨ â†’ Noto Sans CJK JP í°íŠ¸ ì ìš© |
| âœ… í•´ê²° | ì»¤ë¸Œì—ì„œ ì°¨ëŸ‰ ì •ì§€ â†’ Slack variable soft constraint |
| âœ… í•´ê²° | ì»¤ë¸Œì—ì„œ ëœ êº¾ì„ â†’ max_omega_abs, max_omega_rate ì¦ê°€ |

---

## 9. ì˜¤ë²„ìŠˆíŠ¸ / ì»¤ë¸Œ ì´íƒˆ í•´ê²° ë‚´ìš©

### 9-1. ê·¼ë³¸ ì›ì¸: Îº hard constraint ëˆ„ë½ (ì½”ë“œ ìˆ˜ì •)

**ë¬¸ì œ**: ë…¼ë¬¸ Gutjahr 2017 Section IIIì—ì„œ Îº(ê³¡ë¥ )ëŠ” QP **ë‚´ë¶€ì— hard constraint**ë¡œ ë“¤ì–´ê°€ì•¼ í•¨.
```
Îº_min â‰¤ Îº(k) â‰¤ Îº_max  for k=1..N
```
ê¸°ì¡´ ì½”ë“œëŠ” QP ë°–ì—ì„œ `max_omega_abs`ë¡œ Ï‰ = vÂ·Îºë¥¼ ì‚¬í›„ í´ë¦¬í•‘ë§Œ í–ˆìŒ.
â†’ MPCëŠ” í° Îºë¡œ ê³„íš â†’ ì‹¤í–‰ì—ì„œ ì˜ë¦¼ â†’ ë‹¤ìŒ ìŠ¤í…ì— ìƒíƒœ ì˜¤ì°¨ ê¸‰ì¦ â†’ ì˜¤ë²„ìŠˆíŠ¸ í­ë°œ.

**ìˆ˜ì • íŒŒì¼**: `src/bisa/src/ltv_mpc/ltv_mpc.hpp`, `ltv_mpc.cpp`

```cpp
// buildKappaConstraints: Îº state index=2 in x=[dr,Î¸,Îº,Î¸r,Îºr]
// x_free(k) = A_bar*x0 + E_bar*z  â†’  kappa_free = x_free[k*Nx+2]
// constraint: (kappa_min - kappa_free) <= B_bar[k*Nx+2,:]*u <= (kappa_max - kappa_free)
```

QP constraint ìŠ¤íƒ ìˆœì„œ: `[A_in (ì…ë ¥ ë°•ìŠ¤)] + [A_kap (Îº hard)] + [A_lat (lateral soft, if enabled)]`

### 9-2. MPC íŒŒë¼ë¯¸í„° íŠœë‹ (cav_config.yaml)

| íŒŒë¼ë¯¸í„° | ë³€ê²½ ì „ | ë³€ê²½ í›„ | ì´ìœ  |
|---------|--------|--------|------|
| `weight_input` | 0.24 | 0.36 | kappa ë³€í™”ìœ¨ í˜ë„í‹° ì¦ê°€ â†’ ê¸‰ê²©í•œ ì¡°í–¥ ì–µì œ |
| `Q_heading` | 132.0 | 120.0 | ê³¼ë„í•œ heading ë³´ì • ì–µì œ |
| `max_omega_abs` | 1.75 | 1.25 | ìµœëŒ€ yaw-rate ì œí•œ |
| `overshoot_guard_distance` | 0.18 | 0.13 | ì˜¤ë²„ìŠˆíŠ¸ ê°ì§€ ì¡°ê¸°í™” |
| `overshoot_reverse_damping` | 0.62 | 0.52 | ì˜¤ë²„ìŠˆíŠ¸ ì‹œ ê°•í•œ ëŒí•‘ |
| `adaptive_near_cte_thresh` | 0.07 | 0.14 | near-path ê°ì‡  í™œì„±í™” ë²”ìœ„ í™•ëŒ€ |
| `adaptive_near_heading_thresh` | 0.09 | 0.14 | near-path ê°ì‡  í™œì„±í™” ë²”ìœ„ í™•ëŒ€ |

### 9-3. path_hold ê²½ë¡œ ë³´ì •ê°’ í™œì„±í™” (cav_config.yaml)

ì‚¬ìš©ì ìš”êµ¬: "í“¨ì–´í¬ìŠˆíŠ¸ëŠ” ì‚´ì§ì˜ ë³´ì • (fallback_blend=0.08 ìœ ì§€), path_holdë¡œ ê²½ë¡œ ë³´ì • ìµœëŒ€í™”"

| íŒŒë¼ë¯¸í„° | ë³€ê²½ ì „ | ë³€ê²½ í›„ | íš¨ê³¼ |
|---------|--------|--------|------|
| `path_hold_distance_gain` | 0.00 | 0.28 | ê²½ë¡œ ì´íƒˆ ê±°ë¦¬ ë¹„ë¡€ ì†ë„ ê°ì†Œ |
| `path_hold_heading_gain` | 0.00 | 0.22 | ê¸°í•˜í•™ì  ê²½ë¡œ ë³´ì • ë¸”ë Œë”© í™œì„±í™” |
| `path_hold_recovery_distance` | 1000.0 | 0.30 | 30cm ì´íƒˆ ì‹œ recovery ëª¨ë“œ |
| `path_hold_heading_error_gain` | 0.00 | 1.1 | heading ì˜¤ì°¨ ë³´ì • |
| `path_hold_cross_track_gain` | 0.00 | 0.80 | CTE ë³´ì • |
| `path_hold_recovery_blend` | 0.00 | 0.50 | ì´íƒˆ ì‹œ 50% ê²½ë¡œ ë³´ì • ë¸”ë Œë”© |

**path_hold ë¸”ë Œë“œ ë™ì‘:**
- ê²½ë¡œ ìœ„ (dist~0): blend â‰ˆ 0.07 â†’ MPC 93% ì§€ë°°
- ê²½ë¡œ ì´íƒˆ (dist~0.30m): blend â‰ˆ 0.30 â†’ ì ê·¹ì  ë³´ì • ì§„ì…
- ë§ì´ ì´íƒˆ (dist~0.60m): blend â‰ˆ 0.61 â†’ ê°•í•œ ê²½ë¡œ ë³µê·€

---

## 10. í˜„ì¬ CAV01 ìµœì¢… íŒŒë¼ë¯¸í„°

```yaml
mpc_tracker_cav01:
  ros__parameters:
    Q_pos: 100.0
    Q_heading: 120.0
    weight_curvature: 2.0
    weight_input: 0.36
    max_velocity: 0.40
    max_angular_vel: 1.40
    kappa_limit_ref_velocity: 0.60
    max_omega_abs: 1.25
    max_omega_rate: 24.0
    max_v_rate: 1.6
    ref_preview_steps: 24
    lateral_bound: 0.25
    w_lateral_slack_lin: 9000.0
    w_lateral_slack_quad: 90000.0
    enable_path_fallback: true
    fallback_blend: 0.08
    fallback_max_abs_omega: 1.10
    path_hold_distance_gain: 0.28
    path_hold_heading_gain: 0.22
    path_hold_recovery_distance: 0.30
    path_hold_heading_error_gain: 1.1
    path_hold_cross_track_gain: 0.80
    path_hold_recovery_blend: 0.50
    overshoot_guard_distance: 0.13
    overshoot_reverse_damping: 0.52
    adaptive_near_cte_thresh: 0.14
    adaptive_near_heading_thresh: 0.14
    horizon: 60
```

---

*ì‘ì„±: Claude Sonnet 4.6 (1M context) | 2026-02-20*
